<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Edit Product - RefurbE Mart</title>
<link rel="stylesheet" href="styles.css">
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css">

<style>
.edit-container {
    max-width: 600px;
    margin: 50px auto;
    background: #fff;
    padding: 30px;
    border-radius: 10px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.15);
}
.edit-container h2 {
    text-align: center;
    margin-bottom: 25px;
}
.edit-form input,
.edit-form select,
.edit-form textarea {
    width: 100%;
    padding: 12px;
    font-size: 15px;
    margin-bottom: 15px;
    border: 1px solid #aaa;
    border-radius: 6px;
}
.edit-form button {
    width: 100%;
}
.product-preview {
    display: block;
    margin: 0 auto 20px;
    width: 150px;
    border-radius: 8px;
}
</style>
</head>

<body>

<div class="container">
    <div class="navbar">
        <div class="logo">
            <a href="index.html"><img src="images/WEB-STICK-LOGO.png" width="75px"></a>
        </div>
        <nav>
            <ul id="MenuItems">
                <li><a href="index.html">Home</a></li>
                <li><a href="products.html">Products</a></li>
                <li><a href="about.html">About</a></li>
                <li><a href="contact.html">Contact</a></li>
                <li><a href="account.html">Account</a></li>
            </ul>
        </nav>
        <a href="cart.html"><img src="images/cart-logo.png" width="30" height="30"></a>
        <img src="images/menu.png" class="menu-icon" onclick="menutoggle()">
    </div>
</div>

<div class="edit-container">
    <h2>Edit Product</h2>

    <img id="previewImage" src="" class="product-preview">

    <form class="edit-form" id="editForm">
        <input type="text" id="editName" placeholder="Product Name" required>
        <input type="number" id="editPrice" placeholder="Price" required>

        <!-- CONDITION DROPDOWN -->
        <select id="editCondition" required>
            <option value="" disabled>Select Condition</option>
            <option value="Brand New">Brand New</option>
            <option value="Like New">Like New</option>
            <option value="Excellent">Excellent</option>
            <option value="Good">Good</option>
            <option value="Fair">Fair</option>
            <option value="For Parts / Repair">For Parts / Repair</option>
        </select>

        <input type="number" id="editStock" placeholder="Stock" required>

        <!-- TYPE DROPDOWN -->
        <select id="editType" required>
            <option value="" disabled>Select Category</option>
            <option value="Phone">Phone</option>
            <option value="Laptop">Laptop</option>
            <option value="Tablet">Tablet</option>
            <option value="PC Components">PC Components</option>
            <option value="Accessories">Accessories</option>
            <option value="Other">Other</option>
        </select>

        <label>Status:</label>
        <select id="editStatus" required>
            <option value="Selling">Selling</option>
            <option value="Sold Out">Sold Out</option>
            <option value="Suspended">Suspended</option>
            <option value="Withdrawn">Withdrawn</option>
        </select>

        <textarea id="editDescription" placeholder="Product Description" rows="4"></textarea>

        <!-- IMAGE DRAG & DROP -->
        <div id="editImageDrop" style="border:2px dashed #aaa;padding:20px;text-align:center;border-radius:8px;cursor:pointer;">
            <p>Drag & Drop Image Here<br>or Click to Select</p>
        </div>
        <input type="file" id="editImageInput" accept="image/*" style="display:none;">

        <button type="submit" class="btn">Save Changes</button>
    </form>

</div>

<script>
const urlParams = new URLSearchParams(window.location.search);
const productId = urlParams.get("id");

// Load products from main storage
let userProducts = JSON.parse(localStorage.getItem("refurbEProducts")) || [];
let sellingProducts = JSON.parse(localStorage.getItem("refurbESellingProducts")) || [];

// Combine arrays
let products = [...userProducts, ...sellingProducts];

// Find the product
let product = products.find(p => p.id === productId);

// If not found, redirect
if (!product) {
    alert("Product not found.");
    window.location.href = "cart.html#selling";
}


let uploadedImage = "";

// Fill form fields
editName.value = product.name;
editPrice.value = product.price;
editCondition.value = product.condition;
editStock.value = product.stock || 1;
editType.value = product.type || "";
editStatus.value = product.status || "Selling";
editDescription.value = product.description || "";
uploadedImage = product.image;
previewImage.src = uploadedImage;

// Image drag & drop logic
const editImageDrop = document.getElementById("editImageDrop");
const editImageInput = document.getElementById("editImageInput");

editImageDrop.onclick = () => editImageInput.click();

editImageInput.onchange = function() {
    const file = this.files[0];
    readEditImage(file);
};

editImageDrop.ondragover = e => { e.preventDefault(); editImageDrop.style.borderColor = "#4CAF50"; };
editImageDrop.ondragleave = () => editImageDrop.style.borderColor = "#aaa";
editImageDrop.ondrop = e => {
    e.preventDefault();
    editImageDrop.style.borderColor = "#aaa";
    const file = e.dataTransfer.files[0];
    readEditImage(file);
};

function readEditImage(file){
    const reader = new FileReader();
    reader.onload = () => {
        const img = new Image();
        img.src = reader.result;

        img.onload = () => {
            const canvas = document.createElement('canvas');
            const maxSize = 800; 
            let width = img.width;
            let height = img.height;

            if (width > height) { if (width > maxSize) { height *= maxSize / width; width = maxSize; } }
            else { if (height > maxSize) { width *= maxSize / height; height = maxSize; } }

            canvas.width = width;
            canvas.height = height;
            const ctx = canvas.getContext("2d");
            ctx.drawImage(img, 0, 0, width, height);

            uploadedImage = canvas.toDataURL("image/jpeg", 0.7);
            previewImage.src = uploadedImage;
        };
    };
    reader.readAsDataURL(file);
}


// Save changes (UPDATE)
editForm.addEventListener("submit", function(e) {
    e.preventDefault();

    if (!confirm("Save changes?")) return;

    product.name = editName.value;
    product.price = parseFloat(editPrice.value);
    product.condition = editCondition.value;
    product.stock = parseInt(editStock.value);
    product.type = editType.value;
    product.image = uploadedImage;
    product.status = editStatus.value;
    product.description = editDescription.value.trim();

    // Determine which storage array to update
    let storageKey = sellingProducts.some(p => p.id === product.id) ? "refurbESellingProducts" : "refurbEProducts";
    let targetArray = storageKey === "refurbESellingProducts" ? sellingProducts : userProducts;

    // Update the product in the correct array
    const index = targetArray.findIndex(p => p.id === product.id);
    if (index !== -1) {
        targetArray[index] = product;
    }

    // Save back to localStorage
    localStorage.setItem(storageKey, JSON.stringify(targetArray));

    alert("âœ… Product updated successfully!");
    window.location.href = "cart.html#selling";

    });
</script>


</body>
</html>
