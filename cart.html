<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Cart - RefurbE Mart</title>
  <link rel="stylesheet" href="styles.css">
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css">
  <style>
    /* Minimal local styles to ensure new UI looks reasonable if your CSS lacks these */
    .cart-container{max-width:1100px;margin:30px auto;padding:0 16px;}
    .tab-header{display:flex;gap:8px;margin-bottom:18px;flex-wrap:wrap;}
    .tab-btn{padding:10px 14px;border-radius:8px;border:1px solid #ddd;background:#fff;cursor:pointer}
    .tab-btn.active{background:#222;color:#fff}
    .tab-content{display:none}
    .tab-content.active{display:block}
    .selling-card, .cart-item-card, .order-item {background:#fff;padding:12px;border-radius:8px;border:1px solid #eee;margin-bottom:12px;display:flex;align-items:center;gap:12px}
    .selling-card img, .cart-item-card img, .order-item img{width:80px;height:80px;object-fit:cover;border-radius:6px}
    .selling-card h4{margin:0 0 6px 0}
    .selling-card .meta{flex:1}
    .btn{padding:8px 12px;border-radius:6px;border:0;background:#2a6df6;color:#fff;cursor:pointer}
    .btn.edit-btn{background:#f0ad4e}
    .btn.remove-btn{background:#d9534f}
    .cart-summary{margin-top:14px;text-align:right;font-weight:600}
    .small-input{padding:8px;border-radius:6px;border:1px solid #ddd;width:100%;box-sizing:border-box;margin-bottom:10px}
  </style>
</head>
<body>

  <div class="container">
    <div class="navbar">
      <div class="logo"><a href="index.html"><img src="images/WEB-STICK-LOGO.png" width="75px" alt="logo"></a></div>
      <nav>
        <ul id="MenuItems">
          <li><a href="index.html">Home</a></li>
          <li><a href="products.html">Products</a></li>
          <li><a href="about.html">About</a></li>
          <li><a href="contact.html">Contact</a></li>
          <li><a href="account.html">Account</a></li>
        </ul>
      </nav>
      <a href="cart.html"><img src="images/cart-logo.png" width="30" height="30" alt="cart"></a>
      <img src="images/menu.png" class="menu-icon" onclick="menutoggle()" alt="menu">
    </div>
  </div>

  <div class="cart-container">

    <!-- CHANGED: Tab header includes Selling tab (CART / SELL / ORDERS / SELLING) -->
    <div class="tab-header">
      <button class="tab-btn active" data-tab="cart">Cart</button>
      <button class="tab-btn" data-tab="sell">Sell</button>
      <button class="tab-btn" data-tab="orders">Orders</button>
      <button class="tab-btn" data-tab="selling">Selling</button>
    </div>

    <!-- CART TAB: renders items stored in localStorage key 'refurbECart' -->
    <div id="cart" class="tab-content active">
      <h2>Your Cart</h2>
      <div id="cart-items"></div>
      <div class="cart-summary">
        <div id="cart-subtotal">Subtotal: ₱0.00</div>
        <div style="margin-top:8px;"><button class="btn" onclick="openCheckout()">Checkout</button></div>
      </div>
    </div>

    <!-- SELL TAB: form to add a selling product (saves to refurbESellingProducts) -->
    <!-- SELL TAB -->
<div id="sell" class="tab-content">
  <h2>List a Product</h2>

  <form id="sellForm">
    <input class="small-input" id="sell-name" placeholder="Product name" required>

    <input class="small-input" id="sell-price" type="number" step="0.01" min="0" placeholder="Price (₱)" required>

    <!-- CONDITION DROPDOWN -->
    <select class="small-input" id="sell-condition" required>
        <option value="" disabled selected>Select Condition</option>
        <option value="Brand New">Brand New</option>
        <option value="Like New">Like New</option>
        <option value="Excellent">Excellent</option>
        <option value="Good">Good</option>
        <option value="Fair">Fair</option>
        <option value="For Parts / Repair">For Parts / Repair</option>
    </select>

    <input class="small-input" id="sell-stock" type="number" min="0" placeholder="Stock amount" required>

    <!-- TYPE DROPDOWN -->
    <select class="small-input" id="sell-type" required>
        <option value="" disabled selected>Select Category</option>
        <option value="Phone">Phone</option>
        <option value="Laptop">Laptop</option>
        <option value="Tablet">Tablet</option>
        <option value="PC Components">PC Components</option>
        <option value="Accessories">Accessories</option>
        <option value="Other">Other</option>
    </select>

    <!-- PHONE NUMBER ONLY -->
    <input class="small-input" type="text" id="sell-phone" placeholder="Phone Number" required>

    <!-- Product Description -->
    <textarea class="small-input" id="sell-description" placeholder="Describe the product condition, issues, accessories, etc." rows="3"></textarea>

    <!-- Drag & Drop Upload -->
    <div id="imageDrop" style="border:2px dashed #aaa;padding:20px;text-align:center;border-radius:8px;cursor:pointer;">
        <p>Drag & Drop Image Here<br>or Click to Select</p>
    </div>
    <input type="file" id="sell-image-input" accept="image/*" style="display:none;">

    <div style="text-align:right;margin-top:10px;">
        <button class="btn" type="submit">List Product</button>
    </div>
</form>
</div>



    <!-- ORDERS TAB: renders orders from refurbEOrders -->
    <div id="orders" class="tab-content">
      <h2>Your Orders</h2>
      <div id="orders-list"></div>
    </div>

    <!-- SELLING TAB: shows seller-listed products and provides Edit + Delete -->
    <div id="selling" class="tab-content">
      <h2>Your Listings</h2>
      <div id="selling-list"></div>
    </div>

  </div>

  <div class="footer" style="margin-top:30px">
    <p class="copyright">Copyright 2025 - RefurbE Mart</p>
  </div>

  <!-- Message Seller Popup -->
    <div id="sellerPopup" class="popup" style="
        display:none;
        position:fixed;
        top:0; left:0;
        width:100%; height:100%;
        background:rgba(0,0,0,0.5);
        justify-content:center;
        align-items:center;">
        
        <div style="background:#fff; padding:20px; border-radius:8px; width:300px; text-align:center;">
            <h3>Seller Contact</h3>
            <p id="sellerContactInfo">Loading...</p>
            <button onclick="closePopup()" class="btn">Close</button>
        </div>
    </div>

    <script>
        function attachCartEvents() {
            document.querySelectorAll(".msg-seller-btn").forEach(btn => {
                btn.onclick = () => {
                    const index = btn.dataset.index;
                    const cart = JSON.parse(localStorage.getItem("refurbECart")) || [];
                    const item = cart[index];

                    document.getElementById("sellerContactInfo").innerHTML = `
                        <b>${item.sellerName || "Private Seller"}</b><br>
                        Contact: <b>${item.sellerContact || "Not Provided"}</b>
                    `;
                    document.getElementById("sellerPopup").style.display = "flex";
                };
            });
        }

        function closePopup() {
            document.getElementById("sellerPopup").style.display = "none";
        }
    </script>


  <!-- SINGLE menutoggle() FUNCTION (CHANGED: consolidated) -->
  <script>
    var MenuItems = document.getElementById("MenuItems");
    if (MenuItems) MenuItems.style.maxHeight = "0px";
    function menutoggle(){
      if (!MenuItems) return;
      MenuItems.style.maxHeight = (MenuItems.style.maxHeight === "0px" || MenuItems.style.maxHeight === "") ? "200px" : "0px";
    }
  </script>

  <!-- TAB SWITCHING (CHANGED: single handler for all tab buttons) -->
  <script>
    document.querySelectorAll('.tab-btn').forEach(btn => {
      btn.addEventListener('click', function(){
        const tab = this.dataset.tab;
        document.querySelectorAll('.tab-btn').forEach(b=>b.classList.remove('active'));
        document.querySelectorAll('.tab-content').forEach(tc=>tc.classList.remove('active'));
        this.classList.add('active');
        document.getElementById(tab).classList.add('active');

        // When switching to 'orders' or 'selling' or 'cart', make sure content is freshly rendered
        if (tab === 'orders') renderOrders();
        if (tab === 'selling') renderSellingProducts();
        if (tab === 'cart') renderCart();
      });
    });
  </script>

  <script>
    /* -------------------------------
       LOCAL STORAGE HELPERS & KEYS
       -------------------------------
       Keys used:
       - refurbECart            : array of cart items { id, name, price, quantity, image }
       - refurbEOrders          : array of orders objects
       - refurbESellingProducts : array of seller products { id, name, price, condition, stock, type, image, status }
    --------------------------------*/
    function loadCart(){ return JSON.parse(localStorage.getItem('refurbECart')) || []; }
    function saveCart(data){ localStorage.setItem('refurbECart', JSON.stringify(data)); }

    function loadOrders(){ return JSON.parse(localStorage.getItem('refurbEOrders')) || []; }
    function saveOrders(data){ localStorage.setItem('refurbEOrders', JSON.stringify(data)); }

    function loadSellingProducts(){ return JSON.parse(localStorage.getItem('refurbESellingProducts')) || []; }
    function saveSellingProducts(data){ localStorage.setItem('refurbESellingProducts', JSON.stringify(data)); }


  </script>

  <script>
    /* ----------------------------------------
       CART: Render + Remove + Checkout (CHANGED)
       ---------------------------------------- */
    function renderCart(){
      const cart = loadCart();
      const container = document.getElementById('cart-items');
      const subtotalEl = document.getElementById('cart-subtotal');
      container.innerHTML = '';

      if(!cart || cart.length === 0){
        container.innerHTML = '<p>Your cart is empty.</p>';
        subtotalEl.textContent = 'Subtotal: ₱0.00';
        return;
      }

      let subtotal = 0;
      cart.forEach((item, idx) => {
        subtotal += (Number(item.price) * Number(item.quantity || 1));
        container.innerHTML += `
        <div class="cart-item-card">
            <img src="${item.image}" alt="${item.name}">
            <div class="cart-product-info">
            <h4 style="margin:0">${item.name}</h4>
            <div>₱${Number(item.price).toFixed(2)}</div>
            <div>Quantity: ${item.quantity || 1}</div>
            ${item.sellerContact ? `
                <button class="btn" onclick="showSeller('${item.sellerName}', '${item.sellerContact}')">
                Message Seller
                </button>
            ` : ``}
            </div>
            <button class="remove-cart-item-btn" onclick="removeCartItem(${idx})">Remove</button>
        </div>
        `;
      });

      subtotalEl.textContent = 'Subtotal: ₱' + subtotal.toFixed(2);
    }

    function removeCartItem(index){
      const cart = loadCart();
      if (!confirm('Remove this item from the cart?')) return;
      cart.splice(index,1);
      saveCart(cart);
      renderCart();
    }

    function showSeller(name, contact){
        document.getElementById("sellerContactInfo").innerHTML = `
            <b>${name || "Private Seller"}</b><br>
            Phone: <b>${contact || "Not Provided"}</b>
        `;
        document.getElementById("sellerPopup").style.display = "flex";
    }

    // Simple checkout modal / behavior (keeps existing flow)
    function openCheckout(){
      const cart = loadCart();
      if (!cart || cart.length === 0) { alert('Your cart is empty.'); return; }
      // For now create a simple order and clear cart (this is local-only)
      if (!confirm('Proceed to place order for current cart items?')) return;
      const total = cart.reduce((s,i)=> s + (Number(i.price) * Number(i.quantity || 1)), 0);
      const shipping = total > 0 ? 50.00 : 0;
      const order = {
        id: 'RM' + Math.floor(Math.random()*900000 + 100000),
        date: new Date().toLocaleDateString(),
        items: cart,
        total: Number(total) + shipping,
        status: 'Processing',
        paymentMethod: 'COD (local demo)'
      };
      const orders = loadOrders();
      orders.unshift(order);
      saveOrders(orders);
      // clear cart
      saveCart([]);
      alert('Order placed! Order #' + order.id);
      renderOrders();
      renderCart();
      // switch to orders tab
      document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
      document.querySelectorAll('.tab-content').forEach(tc => tc.classList.remove('active'));
      document.querySelector('.tab-btn[data-tab="orders"]').classList.add('active');
      document.getElementById('orders').classList.add('active');
    }

    // initial render
    document.addEventListener('DOMContentLoaded', () => {
      renderCart();
      renderOrders();
      renderSellingProducts();
    });
  </script>

  <script>
    /* ----------------------------------------
       ORDERS: Render + Delete (keeps parity with earlier behavior)
       ---------------------------------------- */
    function renderOrders(filter = 'all'){
      const orders = loadOrders();
      const container = document.getElementById('orders-list');
      container.innerHTML = '';
      if (!orders || orders.length === 0) { container.innerHTML = '<p>No orders yet.</p>'; return; }

      orders.forEach(order => {
        let itemsHtml = '';
        (order.items || []).forEach(it => itemsHtml += `<li>${it.quantity || 1}x ${it.name}</li>`);

        container.innerHTML += `
          <div class="order-item">
            <img src="${order.items && order.items[0] ? order.items[0].image : 'images/product-placeholder.jpg'}" alt="order">
            <div style="flex:1">
              <h4 style="margin:0">Order #${order.id}</h4>
              <div>Date: ${order.date} | Total: ₱${Number(order.total).toFixed(2)}</div>
              <div>Paid: ${order.paymentMethod}</div>
              <ul style="margin:8px 0 0 0; padding-left:18px">${itemsHtml}</ul>
              <a href="#" onclick="deleteOrder('${order.id}')" style="color:#e5442a;display:inline-block;margin-top:8px"><i class="fa fa-trash"></i> Delete Order</a>
            </div>
            <div style="min-width:110px;text-align:center">
              <div style="background:#f4f4f4;padding:8px;border-radius:6px">${order.status}</div>
            </div>
          </div>
        `;
      });
    }

    function deleteOrder(orderId){
      if (!confirm('Delete this order?')) return;
      let orders = loadOrders();
      orders = orders.filter(o => o.id !== orderId);
      saveOrders(orders);
      renderOrders();
    }
  </script>

    <script>
        const imageDrop = document.getElementById("imageDrop");
        const fileInput = document.getElementById("sell-image-input");
        let uploadedImage = "";

        imageDrop.onclick = () => fileInput.click();

        fileInput.onchange = function(){
            const file = this.files[0];
            readImage(file);
        };

        imageDrop.ondragover = (e) => { e.preventDefault(); imageDrop.style.borderColor = "#4CAF50"; };
        imageDrop.ondragleave = () => imageDrop.style.borderColor = "#aaa";
        imageDrop.ondrop = function(e){
            e.preventDefault();
            imageDrop.style.borderColor = "#aaa";
            const file = e.dataTransfer.files[0];
            readImage(file);
        };

        function readImage(file){
            const reader = new FileReader();
            reader.onload = () => {
                const img = new Image();
                img.src = reader.result;

                img.onload = () => {
                    const canvas = document.createElement('canvas');
                    const maxSize = 800; // Max width or height
                    let width = img.width;
                    let height = img.height;

                    // Resize proportionally
                    if (width > height) {
                        if (width > maxSize) {
                            height *= maxSize / width;
                            width = maxSize;
                        }
                    } else {
                        if (height > maxSize) {
                            width *= maxSize / height;
                            height = maxSize;
                        }
                    }

                    canvas.width = width;
                    canvas.height = height;
                    const ctx = canvas.getContext("2d");
                    ctx.drawImage(img, 0, 0, width, height);

                    // Convert to compressed JPEG Base64
                    uploadedImage = canvas.toDataURL("image/jpeg", 0.7);

                    // Show preview
                    imageDrop.innerHTML = `<img src="${uploadedImage}" style="max-width:100%;border-radius:6px;">`;
                };
            };
            reader.readAsDataURL(file);
        }
    </script>

  <script>
    /* ----------------------------------------
       SELLING: Create / Read / Delete / Edit-redirect (CRUD)
       - Create: handled by sell form
       - Read: renderSellingProducts()
       - Update: redirects to edit-product.html where you handle the update
       - Delete: deleteSellingProduct()
       ---------------------------------------- */

    // CHANGED: Hook the sell form and fix references using document.getElementById(...)
    document.getElementById('sellForm').addEventListener('submit', function(e){
      e.preventDefault();
      const newProduct = {
        id: 'SP' + Date.now(),
        name: document.getElementById('sell-name').value.trim(),
        price: parseFloat(document.getElementById('sell-price').value) || 0,
        condition: document.getElementById('sell-condition').value.trim(),
        stock: parseInt(document.getElementById('sell-stock').value) || 0,
        type: document.getElementById('sell-type').value.trim(),
        description: document.getElementById('sell-description').value.trim(),
        sellerName: "Private Seller",
        sellerContact: document.getElementById('sell-phone').value.trim(),  
        image: uploadedImage || 'images/product-placeholder.jpg',
        status: 'Selling'
};


      const products = loadSellingProducts();
      products.unshift(newProduct);
      saveSellingProducts(products);
      renderSellingProducts();
      alert('Product listed successfully!');
      this.reset();

      // switch to selling tab to show the newly added product
      document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
      document.querySelectorAll('.tab-content').forEach(tc => tc.classList.remove('active'));
      document.querySelector('.tab-btn[data-tab="selling"]').classList.add('active');
      document.getElementById('selling').classList.add('active');
    });

    // READ: render selling products
    function renderSellingProducts(){
      const products = loadSellingProducts();
      const container = document.getElementById('selling-list');
      container.innerHTML = '';
      if (!products || products.length === 0) { container.innerHTML = '<p>No listings yet.</p>'; return; }

      products.forEach((p, idx) => {
        container.innerHTML += `
          <div class="selling-card">
            <img src="${p.image}" alt="${p.name}">
            <div class="meta">
              <h4>${p.name}</h4>
              <div>₱${Number(p.price).toFixed(2)} • ${p.condition}</div>
              <div>Stock: ${p.stock} • Type: ${p.type}</div>
              <div>Status: <strong>${p.status}</strong></div>
            </div>
            <div style="display:flex;flex-direction:column;gap:8px">
              <button class="btn edit-btn" onclick="editSellingProduct(${idx})"><i class="fa fa-pencil"></i> Edit</button>
              <button class="btn remove-btn" onclick="deleteSellingProduct(${idx})"><i class="fa fa-trash"></i> Remove</button>
            </div>
          </div>
        `;
      });
    }

    // DELETE selling product
    function deleteSellingProduct(index){
      const products = loadSellingProducts();
      if (!confirm('Remove this listing?')) return;
      products.splice(index,1);
      saveSellingProducts(products);
      renderSellingProducts();
    }

    // EDIT redirect (store index in localStorage so edit-product.html can load it)
    function editSellingProduct(index){
        const products = loadSellingProducts();
        const product = products[index];
        window.location.href = `edit-product.html?id=${product.id}`;
    }

  </script>

</body>
</html>
